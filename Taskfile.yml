version: '3'

# SemEmbed - Containerized Development Workflow
# All tasks use Docker to avoid requiring local Rust installation

vars:
  IMAGE_NAME: semstreams-semembed
  CONTAINER_NAME: semembed-dev
  PORT: 8081

tasks:
  # Build tasks
  build:
    desc: Build Docker image
    cmds:
      - echo "ðŸ”¨ Building semembed Docker image..."
      - docker build -t {{.IMAGE_NAME}}:latest .
      - echo "âœ… Image built: {{.IMAGE_NAME}}:latest"

  build:fast:
    desc: Build Docker image with buildkit cache
    cmds:
      - echo "ðŸ”¨ Building semembed with BuildKit cache..."
      - DOCKER_BUILDKIT=1 docker build --cache-from {{.IMAGE_NAME}}:latest -t {{.IMAGE_NAME}}:latest .
      - echo "âœ… Image built: {{.IMAGE_NAME}}:latest"

  build:no-cache:
    desc: Build Docker image without cache
    cmds:
      - echo "ðŸ”¨ Building semembed without cache..."
      - docker build --no-cache -t {{.IMAGE_NAME}}:latest .
      - echo "âœ… Image built: {{.IMAGE_NAME}}:latest"

  # Run tasks
  run:
    desc: Run semembed service in Docker
    deps: [build]
    cmds:
      - docker rm -f {{.CONTAINER_NAME}} 2>/dev/null || true
      - |
        docker run -d \
          --name {{.CONTAINER_NAME}} \
          -p {{.PORT}}:{{.PORT}} \
          -e SEMEMBED_MODEL=BAAI/bge-small-en-v1.5 \
          -e SEMEMBED_PORT={{.PORT}} \
          -e RUST_LOG=info \
          -v semembed-cache:/home/semembed/.cache/fastembed \
          {{.IMAGE_NAME}}:latest
      - echo "âœ… Service running at http://localhost:{{.PORT}}"
      - echo "ðŸ“Š Health: curl http://localhost:{{.PORT}}/health"
      - echo "ðŸ“ Logs: task logs"

  run:fg:
    desc: Run semembed in foreground (see logs)
    deps: [build]
    cmds:
      - docker rm -f {{.CONTAINER_NAME}} 2>/dev/null || true
      - |
        docker run --rm \
          --name {{.CONTAINER_NAME}} \
          -p {{.PORT}}:{{.PORT}} \
          -e SEMEMBED_MODEL=BAAI/bge-small-en-v1.5 \
          -e SEMEMBED_PORT={{.PORT}} \
          -e RUST_LOG=info \
          -v semembed-cache:/home/semembed/.cache/fastembed \
          {{.IMAGE_NAME}}:latest

  run:base:
    desc: Run with bge-base-en-v1.5 model (higher quality)
    deps: [build]
    cmds:
      - docker rm -f {{.CONTAINER_NAME}} 2>/dev/null || true
      - |
        docker run -d \
          --name {{.CONTAINER_NAME}} \
          -p {{.PORT}}:{{.PORT}} \
          -e SEMEMBED_MODEL=BAAI/bge-base-en-v1.5 \
          -e SEMEMBED_PORT={{.PORT}} \
          -e RUST_LOG=info \
          -v semembed-cache:/home/semembed/.cache/fastembed \
          {{.IMAGE_NAME}}:latest
      - echo "âœ… Service running with bge-base-en-v1.5 model"

  run:minilm:
    desc: Run with all-MiniLM-L6-v2 model (fast, lightweight)
    deps: [build]
    cmds:
      - docker rm -f {{.CONTAINER_NAME}} 2>/dev/null || true
      - |
        docker run -d \
          --name {{.CONTAINER_NAME}} \
          -p {{.PORT}}:{{.PORT}} \
          -e SEMEMBED_MODEL=sentence-transformers/all-MiniLM-L6-v2 \
          -e SEMEMBED_PORT={{.PORT}} \
          -e RUST_LOG=info \
          -v semembed-cache:/home/semembed/.cache/fastembed \
          {{.IMAGE_NAME}}:latest
      - echo "âœ… Service running with all-MiniLM-L6-v2 model"

  # Test tasks
  test:health:
    desc: Test health endpoint
    cmds:
      - echo "ðŸ§ª Testing health endpoint..."
      - curl -f http://localhost:{{.PORT}}/health || (echo "âŒ Health check failed" && exit 1)
      - echo "âœ… Health check passed"

  test:embed:
    desc: Test embeddings endpoint (OpenAI-compatible)
    cmds:
      - echo "ðŸ§ª Testing embeddings..."
      - |
        curl -X POST http://localhost:{{.PORT}}/v1/embeddings \
          -H "Content-Type: application/json" \
          -d '{
            "input": "This is a test sentence for embedding",
            "model": "BAAI/bge-small-en-v1.5"
          }' || (echo "âŒ Embeddings test failed" && exit 1)
      - echo ""
      - echo "âœ… Embeddings test passed"

  test:batch:
    desc: Test batch embeddings
    cmds:
      - echo "ðŸ§ª Testing batch embeddings..."
      - |
        curl -X POST http://localhost:{{.PORT}}/v1/embeddings \
          -H "Content-Type: application/json" \
          -d '{
            "input": ["First sentence", "Second sentence", "Third sentence"],
            "model": "BAAI/bge-small-en-v1.5"
          }' || (echo "âŒ Batch embeddings test failed" && exit 1)
      - echo ""
      - echo "âœ… Batch embeddings test passed"

  test:models:
    desc: Test models endpoint
    cmds:
      - echo "ðŸ§ª Testing models endpoint..."
      - curl -f http://localhost:{{.PORT}}/models || (echo "âŒ Models endpoint test failed" && exit 1)
      - echo ""
      - echo "âœ… Models endpoint test passed"

  test:all:
    desc: Run all tests
    deps: [test:health, test:embed, test:batch, test:models]
    cmds:
      - echo "âœ… All tests passed"

  # Development tasks
  logs:
    desc: View service logs
    cmds:
      - docker logs -f {{.CONTAINER_NAME}}

  logs:tail:
    desc: Tail last 50 lines of logs
    cmds:
      - docker logs --tail 50 {{.CONTAINER_NAME}}

  shell:
    desc: Open shell in running container
    cmds:
      - docker exec -it {{.CONTAINER_NAME}} /bin/bash

  restart:
    desc: Restart the service
    cmds:
      - docker restart {{.CONTAINER_NAME}}
      - echo "âœ… Service restarted"

  stop:
    desc: Stop the service
    cmds:
      - docker stop {{.CONTAINER_NAME}}
      - echo "âœ… Service stopped"

  # Metrics and monitoring
  metrics:
    desc: View Prometheus metrics
    cmds:
      - curl -s http://localhost:{{.PORT}}/metrics

  # Clean tasks
  clean:
    desc: Stop and remove container
    cmds:
      - docker rm -f {{.CONTAINER_NAME}} 2>/dev/null || true
      - echo "âœ… Container removed"

  clean:image:
    desc: Remove Docker image
    deps: [clean]
    cmds:
      - docker rmi {{.IMAGE_NAME}}:latest 2>/dev/null || true
      - echo "âœ… Image removed"

  clean:cache:
    desc: Remove model cache volume
    deps: [clean]
    cmds:
      - docker volume rm semembed-cache 2>/dev/null || true
      - echo "âœ… Model cache removed"

  clean:all:
    desc: Clean everything (container, image, cache)
    deps: [clean, clean:image, clean:cache]
    cmds:
      - echo "âœ… Complete cleanup finished"

  # Docker Compose integration
  compose:up:
    desc: Start with docker-compose (from semstreams dir)
    dir: ../semstreams
    cmds:
      - docker compose -f docker-compose.services.yml --profile embedding up -d
      - echo "âœ… Service started via docker-compose"

  compose:down:
    desc: Stop docker-compose services
    dir: ../semstreams
    cmds:
      - docker compose -f docker-compose.services.yml --profile embedding down
      - echo "âœ… Service stopped"

  compose:logs:
    desc: View docker-compose logs
    dir: ../semstreams
    cmds:
      - docker compose -f docker-compose.services.yml logs -f semembed

  # Development workflow shortcuts
  dev:
    desc: Full development cycle (build + run + test)
    cmds:
      - task build
      - task run
      - sleep 5  # Wait for service to start
      - task test:all
      - echo "âœ… Development cycle complete"

  dev:rebuild:
    desc: Rebuild and restart service
    cmds:
      - task clean
      - task build:no-cache
      - task run
      - echo "âœ… Service rebuilt and running"

  # CI/CD helpers
  ci:test:
    desc: CI test workflow (build + run + test + cleanup)
    cmds:
      - task build
      - task run
      - sleep 10  # Wait for model download
      - task test:all
      - task clean
      - echo "âœ… CI tests passed"

  # Help
  default:
    desc: Show available tasks
    silent: true
    cmds:
      - task --list

  help:
    desc: Show detailed usage guide
    silent: true
    cmds:
      - |
        echo "SemEmbed - Containerized Development Tasks"
        echo ""
        echo "Quick Start:"
        echo "  task dev              # Build, run, and test"
        echo "  task logs             # View service logs"
        echo "  task test:embed       # Test embeddings"
        echo ""
        echo "Build & Run:"
        echo "  task build            # Build Docker image"
        echo "  task run              # Run service (background)"
        echo "  task run:fg           # Run service (foreground)"
        echo "  task run:base         # Run with bge-base model"
        echo "  task run:minilm       # Run with MiniLM model"
        echo "  task stop             # Stop service"
        echo ""
        echo "Testing:"
        echo "  task test:health      # Health check"
        echo "  task test:embed       # Single embedding test"
        echo "  task test:batch       # Batch embeddings test"
        echo "  task test:all         # All tests"
        echo ""
        echo "Development:"
        echo "  task logs             # Follow logs"
        echo "  task shell            # Open container shell"
        echo "  task restart          # Restart service"
        echo "  task dev:rebuild      # Full rebuild"
        echo ""
        echo "Docker Compose:"
        echo "  task compose:up       # Start with compose"
        echo "  task compose:down     # Stop compose"
        echo "  task compose:logs     # View compose logs"
        echo ""
        echo "Cleanup:"
        echo "  task clean            # Remove container"
        echo "  task clean:all        # Remove everything"
